"use strict";angular.module("pixApp",[]),angular.module("pixApp").controller("ListCtrl",["$scope","$rootScope","picturesFetcher","localAPI",function(a,b,c,d){a.methods={init:function(){f.getPictures(),d.init(),b.$on("inViewport",f.handleInViewport),b.$on("updatedRatings",function(){e.ratings=d.data.ratings})},getPictures:function(){e.loading||(e.loading=!0,c.request().success(function(a){c.parseData(a),e.loading=!1,e.firstLoad&&(d.viewed(e.pictures[1].photos[0].id),e.firstLoad=!1)}))},handleInViewport:function(a,b,c){"loadMore"===c.inViewport?f.getPictures():"true"===b.attr("img-preload")&&d.viewed(parseInt(c.inViewport))},rate:function(a,b){d.rate(a,b)}},a.data={firstLoad:!0,loading:!1,pictures:c.data.raw,nomore:c.data.noMorePages,ratings:d.data.ratings};var e=a.data,f=a.methods;f.init()}]),angular.module("pixApp").service("picturesFetcher",["$http",function(a){var b=this;b.config={url:"https://api.500px.com/v1/photos",consumerKey:"OcgBGxhjnjZvbBeaQalnYcSoZ6vjz72qeomgG5AD",image_size:4},b.data={lastPage:0,noMorePages:!1,loading:!1,raw:{}},b.defaultQuery={feature:"popular",sort:"created_at",consumer_key:b.config.consumerKey,image_size:b.config.image_size,page:1},b.request=function(c){b.defaultQuery.page=b.data.lastPage+1;var d=angular.extend(b.defaultQuery,c);return a({method:"GET",url:b.config.url,params:d})},b.parseData=function(a){b.data.raw[a.current_page]=a,b.data.lastPage=Math.max(b.data.lastPage,a.current_page),b.data.noMorePages=a.current_page>=a.total_pages?!0:!1}}]),angular.module("pixApp").directive("inViewport",["$rootScope",function(a){return{restrict:"A",link:function(b,c,d){function e(){function b(a,b){for(var c=a.offsetTop,d=a.offsetLeft,e=a.offsetWidth,f=a.offsetHeight;a.offsetParent;)a=a.offsetParent,c+=a.offsetTop,d+=a.offsetLeft;return c>=b.pageYOffset&&d>=b.pageXOffset&&c+f<=b.pageYOffset+b.innerHeight&&d+e<=b.pageXOffset+b.innerWidth}b(c[0],g)&&a.$broadcast("inViewport",c,d)}var f=angular.element,g=window;f(g).on("scroll",e),e()}}}]),angular.module("pixApp").service("localAPI",["$http","$rootScope",function(a,b){var c=this;c.config={url:"http://demo9752422.mockable.io/localapi/",interval:4e3},c.data={sentViews:[],forSendViews:[],ratings:{},lastSend:new Date},c.init=function(){c.getRatings(),setInterval(c.tickSend,c.config.interval)},c.getRatings=function(){a({method:"GET",url:c.config.url}).success(function(a){c.data.ratings=angular.extend(a,c.data.ratings),b.$broadcast("updatedRatings")})},c.viewed=function(a){c.data.forSendViews.indexOf(a)<0&&c.data.forSendViews.push(a)},c.tickSend=function(){c.data.lastSend=new Date,c.data.forSendViews.length&&c.sendViewed()},c.sendViewed=function(){a({method:"POST",url:c.config.url,data:{type:"views",pictures:c.data.forSendViews}}).success(function(){c.data.forSendViews=[]})},c.rate=function(d,e){c.data.ratings[d]!==e&&(c.data.ratings[d]=e,b.$broadcast("updatedRatings"),a({method:"POST",url:c.config.url,data:{type:e,picture:d}}).error(function(){delete c.data.ratings[d],b.$broadcast("updatedRatings")}))}}]),angular.module("pixApp").directive("imgPreload",function(){return{restrict:"A",scope:{ngSrc:"@"},link:function(a,b,c){b.on("load",function(){b.attr("img-preload","true")})}}});